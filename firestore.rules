rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isNumber(value) {
      return value is int || value is float;
    }

    function validFacebookUrl(url) {
      return url is string
        && url.size() > 0
        && url.matches('^https?://(www\\.|m\\.)?facebook\\.com/.+');
    }

    function validImageUrl(url) {
      return url is string
        && url.size() > 0
        && url.matches('^https?://.+');
    }

    function validCaseBase(data) {
      return data.keys().hasAll([
          'caseType',
          'status',
          'petName',
          'species',
          'description',
          'locationText',
          'eventDate',
          'contact',
          'urgency',
          'commentCount',
          'createdAt',
          'updatedAt'
        ])
        && (data.caseType == 'lost' || data.caseType == 'found')
        && (data.status == 'open' || data.status == 'reunited')
        && data.petName is string
        && data.petName.size() > 0
        && data.species is string
        && data.description is string
        && data.description.size() <= 500
        && data.contact is string
        && data.contact.size() <= 80
        && data.locationText is string
        && data.eventDate is string
        && data.urgency is string
        && isNumber(data.commentCount)
        && isNumber(data.createdAt)
        && isNumber(data.updatedAt);
    }

    function validDonationBase(data) {
      return data.keys().hasAll([
          'campaignTitle',
          'beneficiary',
          'goalAmount',
          'raisedAmount',
          'urgency',
          'contact',
          'description',
          'facebookPostUrl',
          'status',
          'commentCount',
          'createdAt',
          'updatedAt'
        ])
        && data.campaignTitle is string
        && data.campaignTitle.size() > 0
        && data.beneficiary is string
        && data.contact is string
        && data.contact.size() <= 80
        && data.description is string
        && data.description.size() <= 500
        && validFacebookUrl(data.facebookPostUrl)
        && (data.status == 'draft' || data.status == 'active' || data.status == 'completed')
        && isNumber(data.goalAmount)
        && isNumber(data.raisedAmount)
        && isNumber(data.commentCount)
        && isNumber(data.createdAt)
        && isNumber(data.updatedAt);
    }

    function validComment(data) {
      return data.keys().hasAll([
          'authorName',
          'authorContact',
          'text',
          'language',
          'status',
          'createdAt',
          'updatedAt'
        ])
        && data.authorName is string
        && data.authorName.size() > 0
        && data.authorName.size() <= 40
        && data.authorContact is string
        && data.authorContact.size() > 0
        && data.authorContact.size() <= 70
        && data.text is string
        && data.text.size() > 0
        && data.text.size() <= 500
        && (data.status == 'active' || data.status == 'flagged')
        && isNumber(data.createdAt)
        && isNumber(data.updatedAt);
    }

    match /petCases/{caseId} {
      allow read: if true;
      allow create: if validCaseBase(request.resource.data)
        && validImageUrl(request.resource.data.photoUrl);
      allow update: if validCaseBase(request.resource.data)
        && (
          validImageUrl(request.resource.data.photoUrl)
          || (
            !request.resource.data.keys().hasAny(['photoUrl'])
            && !resource.data.keys().hasAny(['photoUrl'])
          )
        );
    }

    match /petCases/{caseId}/comments/{commentId} {
      allow read: if true;
      allow create: if validComment(request.resource.data);
      allow update: if validComment(request.resource.data);
    }

    match /donations/{donationId} {
      allow read: if true;
      allow create: if validDonationBase(request.resource.data)
        && validImageUrl(request.resource.data.photoUrl);
      allow update: if validDonationBase(request.resource.data)
        && (
          validImageUrl(request.resource.data.photoUrl)
          || (
            !request.resource.data.keys().hasAny(['photoUrl'])
            && !resource.data.keys().hasAny(['photoUrl'])
          )
        );
    }

    match /donations/{donationId}/comments/{commentId} {
      allow read: if true;
      allow create: if validComment(request.resource.data);
      allow update: if validComment(request.resource.data);
    }
  }
}
